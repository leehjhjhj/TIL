중복 데이터 생성에 대한 고분분투기에 대해서 공유드립니다.

## 안심 결제와 정산 데이터

저희 서비스에는 안심결제라는 결제수단이 존재합니다. 안심결제를 결제 수단으로 상품을 구매를 하면 두 가지, 혹은 한 가지의 정산데이터가 생성됩니다.

하나는 판매자의 전체 정산을 관리하는 **판매자 정산 데이터**이고, 다른 하나는 각 상품별 정산 정보를 담고 있는 **개별 상품 정산 데이터**입니다. 이 두 데이터는 1:N 관계를 가지고 있어, 하나의 판매자 정산 데이터에 여러 개의 상품 정산 데이터가 연결될 수 있습니다.

![](https://velog.velcdn.com/images/leehjhjhj/post/277ce500-dc51-47ac-aa55-f601fe1f2c29/image.png)

앞서 상품 결제시 생성되는 데이터가 ‘두 가지, 혹은 한 가지’ 라고 한 이유는 다음과 같습니다. 구매자가 안심결제로 상품을 구매할 때 먼저 **판매자 정산 데이터**가 생성됩니다. 이후 구매한 각각의 상품에 대해 **개별 상품 정산 데이터**가 생성되며, 해당 상품에 대한 판매자 정산 데이터의 총액이 자동으로 업데이트됩니다.

중요한 점은 **해당 상품에 대한 `pending` 상태의 판매자 정산 데이터가 남아있으면, 다음 구매 발생시 재생성되지 않는다는 점**입니다. 즉, 판매자가 정산을 받지 않는다면 상품 하나당 **판매자 정산 데이터는 오직 한 개로 존재합니다.**

여기서 문제가 발생합니다. 만약 해당 상품이 인기가 엄청나서 구매 즉시 결제가 동시에 많이 일어나는 상품이라면, **판매자 정산 데이터가 여러 건 생성이 된다는 것입니다.**

이유는 간단합니다. 기존 코드에 결제가 동시에 발생할 때를 대비한 **경쟁 상태를 제어하는 로직이 존재하지 않기 때문**입니다. 판매자 정산 데이터가 없는 상태에서 0.01초 간격으로 결제가 동시에 발생하면, `pending` 상태인 판매자 정산 데이터가 없다고 간주하여 여러 건이 생성되는 것입니다.
![](https://velog.velcdn.com/images/leehjhjhj/post/40b91be1-90a3-4b6b-a018-f19538419a69/image.png)

만약 이런 일이 발생하게 되면, 판매자는 정산 페이지에서 같은 상품에 대해 여러 건의 정산 데이터가 생성된 것을 보게되는 당황스러운 일이 발생합니다.

![](https://velog.velcdn.com/images/leehjhjhj/post/709db409-2492-454a-8f0c-567b46a51594/image.png)![](https://velog.velcdn.com/images/leehjhjhj/post/747f5bfc-dc95-45da-b3f7-821da3940722/image.png)

이와 같은 일이 발생하면 아주 번거로운 일이 발생합니다. 우선 운영팀이 CS를 받아서 백엔드팀에게 데이터 수정을 요청하고, 백엔드 팀은 여러 개의 판매자 정산 데이터를 하나로 만든 뒤 개별 상품 정산 데이터의 금액을 모두 합하여 총 정산 데이터를 업데이트 해줍니다.

만약 조금의 실수가 있으면 판매자에게 더 높은 금액으로 정산이 되거나, 덜 되거나 하는 아찔한 상황이 벌어지기 때문에, 해당 CS가 들어오면 운영팀과 개발팀 모두 큰 힘을 쏟아 처리해야 했습니다.

때문에 이를 해결하기 위해서 다음과 같은 몇 가지 방법을 시도해보았습니다.
